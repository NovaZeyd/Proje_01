<!DOCTYPE html>
<html lang="az">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÆDV ÆvÉ™zlÉ™ÅŸmÉ™ Sistemi</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root{
  --bg:#0d0f1a;--card:#1a1f2e;--card2:#222840;--sidebar:#111827;
  --accent:#6366f1;--accent2:#10b981;--red:#ef4444;--yellow:#f59e0b;
  --orange:#f97316;--purple:#8b5cf6;--cyan:#06b6d4;
  --text:#e2e8f0;--muted:#64748b;--border:#1e2a3a;
}
*{box-sizing:border-box;margin:0;padding:0}
body{background:var(--bg);color:var(--text);font-family:'Segoe UI',system-ui,sans-serif;min-height:100vh;display:flex;flex-direction:column}

/* TOPBAR */
.topbar{background:var(--sidebar);border-bottom:1px solid var(--border);padding:0 18px;height:54px;display:flex;align-items:center;gap:12px;flex-shrink:0}
.topbar h1{font-size:.9rem;font-weight:800;white-space:nowrap}
.topbar a{color:var(--muted);font-size:.76rem;text-decoration:none;white-space:nowrap}
.topbar a:hover{color:var(--text)}
.topbar-right{margin-left:auto;display:flex;align-items:center;gap:8px}

/* PERIOD BAR */
.period-bar{background:var(--card);border-bottom:1px solid var(--border);padding:8px 18px;display:flex;align-items:flex-end;gap:12px;flex-wrap:wrap;flex-shrink:0}
.pb-group{display:flex;flex-direction:column;gap:3px}
.pb-label{font-size:.65rem;color:var(--muted);text-transform:uppercase;letter-spacing:.5px}
select,.search-inp{background:var(--card2);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:6px;font-size:.78rem}
.upload-btn{padding:6px 12px;border-radius:6px;font-size:.72rem;cursor:pointer;background:var(--card2);border:1px dashed var(--border);color:var(--muted);transition:all .12s;display:inline-block}
.upload-btn:hover{border-color:var(--accent);color:var(--accent)}

/* SYNC BADGE */
.sync-badge{background:rgba(16,185,129,.1);color:var(--accent2);border:1px solid rgba(16,185,129,.3);padding:4px 10px;border-radius:6px;font-size:.7rem;white-space:nowrap}
.sync-badge.warn{background:rgba(245,158,11,.1);color:var(--yellow);border-color:rgba(245,158,11,.3)}

/* MAIN LAYOUT */
.workspace{display:grid;grid-template-columns:1fr 360px;flex:1;overflow:hidden;min-height:0}
@media(max-width:1100px){.workspace{grid-template-columns:1fr}}

/* PANELS */
.panel{display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--border)}
.panel-right{border-right:none;border-left:1px solid var(--border)}
.panel-head{background:var(--card2);padding:10px 14px;display:flex;align-items:center;gap:8px;flex-shrink:0;border-bottom:1px solid var(--border)}
.panel-head h3{font-size:.82rem;font-weight:700}
.panel-body{overflow-y:auto;flex:1}

/* FILTER TABS (status) */
.inv-tabs{display:flex;background:var(--card2);border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto}
.itab{padding:9px 14px;font-size:.74rem;cursor:pointer;border:none;background:none;color:var(--muted);border-bottom:2px solid transparent;white-space:nowrap;transition:all .15s}
.itab.active{color:var(--accent);border-bottom-color:var(--accent);background:rgba(99,102,241,.06)}
.itab .cnt{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border-radius:50%;font-size:.65rem;font-weight:700;background:var(--border);margin-left:4px}
.itab.active .cnt{background:var(--accent);color:#fff}

/* TABLE */
.tbl-wrap{overflow-x:auto}
table.inv-tbl{width:100%;border-collapse:collapse;font-size:.76rem}
table.inv-tbl th{background:var(--card2);padding:8px 10px;text-align:left;color:var(--muted);font-weight:600;white-space:nowrap;position:sticky;top:0;z-index:10;border-bottom:1px solid var(--border)}
table.inv-tbl td{padding:8px 10px;border-bottom:1px solid rgba(30,42,58,.6);vertical-align:middle;white-space:nowrap}
table.inv-tbl tr:hover td{background:rgba(99,102,241,.05);cursor:pointer}
table.inv-tbl tr.warn-old td{background:rgba(239,68,68,.03)}
table.inv-tbl tr.selected td{background:rgba(99,102,241,.1)}
.num{text-align:right;font-variant-numeric:tabular-nums}
.voen-cell{font-size:.7rem;color:var(--muted);font-variant-numeric:tabular-nums}
.name-cell{max-width:160px;overflow:hidden;text-overflow:ellipsis;font-weight:600}
.seriya-cell{color:var(--accent);font-weight:700}
.no-cell{color:var(--text);font-variant-numeric:tabular-nums}
.edv-cell{font-weight:700;color:var(--accent2)}
.edvsiz-cell{color:var(--muted)}

/* PROGRESS MINI */
.prog-mini{width:50px;height:4px;background:var(--border);border-radius:2px;display:inline-block;vertical-align:middle;margin-left:4px}
.prog-mini-fill{height:100%;border-radius:2px;background:var(--accent2)}

/* BADGES */
.badge{display:inline-flex;align-items:center;gap:3px;padding:2px 7px;border-radius:20px;font-size:.63rem;font-weight:700;white-space:nowrap}
.b-gozleyir{background:rgba(100,116,139,.15);color:#94a3b8}
.b-qismen{background:rgba(245,158,11,.15);color:var(--yellow)}
.b-tam{background:rgba(16,185,129,.15);color:var(--accent2)}
.b-avazlesdirilib{background:rgba(99,102,241,.15);color:var(--accent)}
.b-kohne{background:rgba(239,68,68,.15);color:var(--red)}
.b-avans{background:rgba(6,182,212,.15);color:var(--cyan)}
.b-qismen-avaz{background:rgba(139,92,246,.15);color:var(--purple)}

/* PAYMENT PANEL */
.pay-row{padding:10px 12px;border-bottom:1px solid rgba(30,42,58,.7);cursor:pointer;transition:background .12s}
.pay-row:hover{background:rgba(99,102,241,.05)}
.pay-row.unmatched{background:rgba(245,158,11,.04);border-left:3px solid var(--yellow)}
.pay-row.matched{opacity:.75}
.pay-head{display:flex;justify-content:space-between;align-items:center}
.pay-amount{font-size:.88rem;font-weight:800;color:var(--accent2)}
.pay-sub{font-size:.7rem;color:var(--muted);margin-top:3px}
.pay-ref{font-size:.72rem;color:var(--cyan);margin-top:2px;word-break:break-all}
.pay-match-lbl{font-size:.67rem;color:var(--accent);margin-top:3px;cursor:pointer;text-decoration:underline}
.match-link{color:var(--accent);font-size:.68rem;cursor:pointer;text-decoration:underline}

/* SUMMARY */
.sum-section{border-top:1px solid var(--border);background:var(--card);flex-shrink:0}
.sum-head{padding:8px 16px;display:flex;align-items:center;gap:8px;cursor:pointer;background:var(--card2);border-bottom:1px solid var(--border)}
.sum-head h3{font-size:.8rem;font-weight:700}
.sum-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:8px;padding:12px 16px}
.sum-item{background:var(--card2);border-radius:7px;padding:10px 12px}
.sum-lbl{font-size:.62rem;color:var(--muted);margin-bottom:3px;text-transform:uppercase;letter-spacing:.5px}
.sum-val{font-size:1rem;font-weight:800}
.sv-green{color:var(--accent2)}
.sv-yellow{color:var(--yellow)}
.sv-red{color:var(--red)}
.sv-cyan{color:var(--cyan)}
.sv-purple{color:var(--purple)}

/* ALERTS */
.alert-strip{padding:7px 14px;font-size:.74rem;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;flex-shrink:0}
.alert-strip.warn{background:rgba(245,158,11,.08);color:var(--yellow)}
.alert-strip.err{background:rgba(239,68,68,.08);color:var(--red)}
.alert-strip.info{background:rgba(99,102,241,.08);color:var(--accent)}
.alert-strip.ok{background:rgba(16,185,129,.08);color:var(--accent2)}

/* BUTTONS */
.btn{padding:6px 14px;border-radius:6px;font-size:.76rem;cursor:pointer;border:none;font-weight:600;transition:all .15s}
.btn.primary{background:var(--accent);color:#fff}
.btn.success{background:var(--accent2);color:#fff}
.btn.warn{background:var(--yellow);color:#000}
.btn.ghost{background:none;border:1px solid var(--border);color:var(--muted)}
.btn.ghost:hover{border-color:var(--accent);color:var(--text)}
.btn.danger{background:var(--red);color:#fff}
.btn.sm{padding:3px 8px;font-size:.68rem}

/* MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.65);z-index:800;align-items:center;justify-content:center}
.modal-overlay.show{display:flex}
.modal{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:24px;max-width:560px;width:92%;max-height:85vh;overflow-y:auto}
.modal h3{font-size:.92rem;font-weight:800;margin-bottom:12px}
.modal-close{float:right;background:none;border:none;color:var(--muted);cursor:pointer;font-size:1.1rem;margin-top:-2px}
.modal-tbl{width:100%;border-collapse:collapse;font-size:.76rem;margin-top:8px}
.modal-tbl th{background:var(--card2);padding:7px 10px;text-align:left;color:var(--muted);font-weight:600}
.modal-tbl td{padding:7px 10px;border-bottom:1px solid var(--border)}
.modal-tbl tr:last-child td{border-bottom:none}

/* FIFO */
.fifo-row{display:flex;align-items:flex-start;gap:8px;padding:8px;background:rgba(245,158,11,.05);border-radius:6px;margin-bottom:6px;font-size:.76rem}

/* NOTIF */
#notif-avans{display:none;position:fixed;bottom:18px;right:18px;background:var(--card);border:1px solid var(--cyan);border-radius:10px;padding:14px 16px;max-width:300px;z-index:700;box-shadow:0 4px 20px rgba(0,0,0,.4)}

/* EMPTY */
.empty{text-align:center;padding:28px;color:var(--muted);font-size:.8rem}

/* CHIPS */
.chips{display:flex;gap:6px;padding:7px 12px;border-bottom:1px solid var(--border);flex-shrink:0;flex-wrap:wrap}
.chip{padding:3px 9px;border-radius:20px;font-size:.67rem;cursor:pointer;border:1px solid var(--border);color:var(--muted);transition:all .12s}
.chip.active{border-color:var(--accent);color:var(--accent);background:rgba(99,102,241,.08)}

::-webkit-scrollbar{width:5px;height:5px}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <span style="font-size:1.1rem">ğŸ”„</span>
  <h1>ÆDV ÆvÉ™zlÉ™ÅŸmÉ™ Sistemi</h1>
  <span style="color:var(--border)">|</span>
  <a href="index.html">â† PanelÉ™ qayÄ±t</a>
  <div class="topbar-right">
    <div id="sync-indicator" class="sync-badge">âŸ³ Sinxronizasiya</div>
    <button class="btn ghost sm" onclick="runAutoMatch()">âš¡ Avtomatik EÅŸlÉ™ÅŸ</button>
    <button class="btn primary sm" onclick="openFinalModal()">ğŸ“‹ BÉ™yannamÉ™</button>
    <button class="btn success sm" onclick="exportAvaz()">â¬‡ï¸ Export</button>
  </div>
</div>

<!-- PERIOD BAR -->
<div class="period-bar">
  <div class="pb-group">
    <span class="pb-label">Hesabat DÃ¶vrÃ¼</span>
    <select id="sel-ay" onchange="changePeriod()">
      <option value="11-2025">Noyabr 2025</option>
      <option value="12-2025">Dekabr 2025</option>
      <option value="01-2026" selected>Yanvar 2026</option>
      <option value="02-2026">Fevral 2026</option>
    </select>
  </div>
  <div class="pb-group">
    <span class="pb-label">ÅirkÉ™t</span>
    <select id="sel-voen">
      <option value="2302351311">"3V" MMC â€” 2302351311</option>
    </select>
  </div>
  <div class="pb-group">
    <span class="pb-label">AlÄ±ÅŸ QaimÉ™lÉ™ri (e-taxes Excel)</span>
    <label class="upload-btn">ğŸ“¥ Excel Ä°dxal
      <input type="file" accept=".xlsx,.xls" style="display:none" onchange="importQaimeler(this)">
    </label>
  </div>
  <div class="pb-group">
    <span class="pb-label">ÆDV Depozit Ã–dÉ™niÅŸlÉ™ri (e-taxes Excel)</span>
    <label class="upload-btn">ğŸ“¥ Excel Ä°dxal
      <input type="file" accept=".xlsx,.xls" style="display:none" onchange="importDepozit(this)">
    </label>
  </div>
  <div class="pb-group" style="margin-left:auto">
    <span class="pb-label">EÅŸlÉ™ÅŸmÉ™</span>
    <div id="match-stat" style="font-size:.78rem;color:var(--muted);padding:6px 0">â€”</div>
  </div>
</div>

<!-- MAIN WORKSPACE -->
<div class="workspace" style="flex:1;min-height:0">

  <!-- LEFT: QAÄ°MÆLÆR -->
  <div class="panel">
    <div class="panel-head">
      <span>ğŸ“‹</span>
      <h3>AlÄ±ÅŸ QaimÉ™lÉ™ri</h3>
      <div style="margin-left:auto;display:flex;gap:6px;align-items:center">
        <input class="search-inp" type="text" placeholder="ğŸ” Axtar..." oninput="filterInvoices(this.value)" style="width:150px">
        <button class="btn ghost sm" onclick="addInvManual()">+ Æl ilÉ™</button>
      </div>
    </div>

    <!-- STATUS TABS -->
    <div class="inv-tabs" id="inv-tabs">
      <button class="itab active" onclick="setStatusTab(this,'hamisi')">
        HamÄ±sÄ± <span class="cnt" id="cnt-hamisi">0</span>
      </button>
      <button class="itab" onclick="setStatusTab(this,'gozleyir')">
        AÃ§Ä±q / Ã–dÉ™nilmÉ™miÅŸ <span class="cnt" id="cnt-gozleyir">0</span>
      </button>
      <button class="itab" onclick="setStatusTab(this,'qismen')">
        QismÉ™n Ã–dÉ™nilib <span class="cnt" id="cnt-qismen">0</span>
      </button>
      <button class="itab" onclick="setStatusTab(this,'tam')">
        Tam Ã–dÉ™nilib <span class="cnt" id="cnt-tam">0</span>
      </button>
      <button class="itab" onclick="setStatusTab(this,'avazlesdirilib')">
        ÆvÉ™zlÉ™ÅŸdirilib <span class="cnt" id="cnt-avaz">0</span>
      </button>
      <button class="itab" onclick="setStatusTab(this,'kohne')">
        KÃ¶hnÉ™ QalÄ±q <span class="cnt" id="cnt-kohne" style="background:rgba(239,68,68,.3)">0</span>
      </button>
      <button class="itab" onclick="setStatusTab(this,'avans')">
        Avans (AA) <span class="cnt" id="cnt-avans" style="background:rgba(6,182,212,.2)">0</span>
      </button>
    </div>

    <!-- ALERTS -->
    <div id="inv-alerts"></div>

    <!-- TABLE -->
    <div class="panel-body">
      <div class="tbl-wrap">
        <table class="inv-tbl" id="inv-table">
          <thead>
            <tr>
              <th>#</th>
              <th>VÃ–EN</th>
              <th>SatÄ±cÄ±nÄ±n AdÄ±</th>
              <th>Tarix</th>
              <th>Seriya</th>
              <th>QaimÉ™ â„–</th>
              <th class="num">ÆDV-siz DÉ™yÉ™r (â‚¼)</th>
              <th class="num">ÆDV MÉ™blÉ™ÄŸi (â‚¼)</th>
              <th class="num">Ã–dÉ™nilmiÅŸ (â‚¼)</th>
              <th>Status</th>
              <th>ÆmÉ™liyyat</th>
            </tr>
          </thead>
          <tbody id="inv-tbody"></tbody>
        </table>
      </div>
      <div id="inv-empty" class="empty" style="display:none">
        <div style="font-size:2rem;margin-bottom:8px">ğŸ“­</div>
        Bu filtrdÉ™ qaimÉ™ tapÄ±lmadÄ±
      </div>
    </div>
  </div>

  <!-- RIGHT: DEPOZÄ°T Ã–DÆNÄ°ÅLÆRÄ° -->
  <div class="panel panel-right" style="min-width:0">
    <div class="panel-head">
      <span>ğŸ’³</span>
      <h3>ÆDV Depozit Ã–dÉ™niÅŸlÉ™ri</h3>
      <button class="btn ghost sm" style="margin-left:auto" onclick="addPayManual()">+ Æl ilÉ™</button>
    </div>

    <div id="unmatched-alert" class="alert-strip warn" style="display:none">
      âš ï¸ <span id="unmatched-cnt">0</span> eÅŸlÉ™ÅŸdirilmÉ™miÅŸ â€”
      <span class="match-link" onclick="runAutoMatch()">FIFO eÅŸlÉ™ÅŸ</span>
    </div>

    <div class="chips" id="pay-chips">
      <span class="chip active" onclick="setPayFilter(this,'hamisi')">HamÄ±sÄ±</span>
      <span class="chip" onclick="setPayFilter(this,'unmatched')">EÅŸlÉ™ÅŸdirilmÉ™miÅŸ</span>
      <span class="chip" onclick="setPayFilter(this,'matched')">EÅŸlÉ™ÅŸdirilmiÅŸ</span>
      <span class="chip" onclick="setPayFilter(this,'avans')">Avans</span>
    </div>

    <div class="panel-body" id="pay-list"></div>
  </div>

</div><!-- /workspace -->

<!-- SUMMARY -->
<div class="sum-section">
  <div class="sum-head" onclick="toggleSum()">
    <span>ğŸ“Š</span>
    <h3>ÆvÉ™zlÉ™ÅŸmÉ™ XÃ¼lasÉ™si â€” <span id="sum-period-lbl">Yanvar 2026</span></h3>
    <span style="margin-left:auto;color:var(--muted)" id="sum-toggle">â–²</span>
  </div>
  <div id="sum-body">
    <div id="sum-warnings"></div>
    <div class="sum-grid">
      <div class="sum-item"><div class="sum-lbl">Cari dÃ¶vr (tam Ã¶dÉ™nilib)</div><div class="sum-val sv-green" id="sv-cari">0.00 â‚¼</div></div>
      <div class="sum-item"><div class="sum-lbl">KÃ¶hnÉ™ dÃ¶vrlÉ™rdÉ™n</div><div class="sum-val sv-cyan" id="sv-kohne">0.00 â‚¼</div></div>
      <div class="sum-item"><div class="sum-lbl">Avans qaimÉ™ Ã¼zrÉ™</div><div class="sum-val sv-purple" id="sv-avans">0.00 â‚¼</div></div>
      <div class="sum-item" style="border:1px solid var(--accent2)">
        <div class="sum-lbl">CÆMÄ° ÆVÆZLÆÅDÄ°RÄ°LÆCÆK (1016)</div>
        <div class="sum-val sv-green" id="sv-total">0.00 â‚¼</div>
      </div>
      <div class="sum-item"><div class="sum-lbl">Depozit gÃ¶zlÉ™yir (aÃ§Ä±q qaimÉ™)</div><div class="sum-val sv-yellow" id="sv-goz">0.00 â‚¼</div></div>
      <div class="sum-item"><div class="sum-lbl">QismÉ™n Ã¶dÉ™nilmiÅŸ (qalÄ±q)</div><div class="sum-val sv-yellow" id="sv-qis">0.00 â‚¼</div></div>
      <div class="sum-item"><div class="sum-lbl">SÉ™nÉ™dsiz avans depozit</div><div class="sum-val" style="color:var(--orange)" id="sv-san">0.00 â‚¼</div></div>
      <div class="sum-item"><div class="sum-lbl">EÅŸlÉ™ÅŸmÉ™ faizi</div><div class="sum-val" id="sv-pct">0%</div></div>
    </div>
  </div>
</div>

<!-- â•â• FIFO MODAL â•â• -->
<div class="modal-overlay" id="modal-fifo">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-fifo')">âœ•</button>
    <h3>âš¡ Avtomatik EÅŸlÉ™ÅŸdirmÉ™ TÉ™klifi (FIFO)</h3>
    <p style="font-size:.76rem;color:var(--muted);margin-bottom:12px">AÅŸaÄŸÄ±dakÄ± paylaÅŸdÄ±rmanÄ± tÉ™sdiqlÉ™yin vÉ™ ya dÉ™yiÅŸdirin:</p>
    <div id="fifo-proposals"></div>
    <div style="margin-top:14px;display:flex;gap:8px">
      <button class="btn success" onclick="confirmFifo()">âœ… HamÄ±sÄ±nÄ± TÉ™sdiqlÉ™</button>
      <button class="btn ghost" onclick="closeModal('modal-fifo')">LÉ™ÄŸv et</button>
    </div>
  </div>
</div>

<!-- â•â• INVOICE DETAIL â•â• -->
<div class="modal-overlay" id="modal-inv">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-inv')">âœ•</button>
    <h3 id="modal-inv-title"></h3>
    <div id="modal-inv-body"></div>
  </div>
</div>

<!-- â•â• MANUAL MATCH â•â• -->
<div class="modal-overlay" id="modal-match">
  <div class="modal">
    <button class="modal-close" onclick="closeModal('modal-match')">âœ•</button>
    <h3>ğŸ”— Æl ilÉ™ EÅŸlÉ™ÅŸdirmÉ™</h3>
    <div id="modal-match-body"></div>
    <div style="margin-top:12px;display:flex;gap:8px">
      <button class="btn primary" onclick="confirmManualMatch()">BaÄŸla</button>
      <button class="btn ghost" onclick="closeModal('modal-match')">LÉ™ÄŸv et</button>
    </div>
  </div>
</div>

<!-- â•â• FINAL REPORT â•â• -->
<div class="modal-overlay" id="modal-final">
  <div class="modal" style="max-width:640px">
    <button class="modal-close" onclick="closeModal('modal-final')">âœ•</button>
    <h3>ğŸ“‹ BÉ™yannamÉ™ XÃ¼lasÉ™si â€” <span id="final-period"></span></h3>
    <div id="modal-final-body"></div>
    <div style="margin-top:14px;display:flex;gap:8px;flex-wrap:wrap">
      <button class="btn success" onclick="exportAvaz()">â¬‡ï¸ ÆvÉ™zlÉ™ÅŸdirmÉ™ Excel (e-taxes)</button>
      <button class="btn ghost" onclick="closeModal('modal-final')">BaÄŸla</button>
    </div>
  </div>
</div>

<!-- â•â• AVANS NOTIF â•â• -->
<div id="notif-avans">
  <div style="font-size:.78rem;font-weight:700;color:var(--cyan);margin-bottom:6px">ğŸ’¡ Avans UyÄŸunluÄŸu TapÄ±ldÄ±</div>
  <div id="notif-avans-text" style="font-size:.74rem;color:var(--muted);margin-bottom:8px"></div>
  <div style="display:flex;gap:6px">
    <button class="btn success sm" onclick="acceptAvansLink()">BaÄŸla</button>
    <button class="btn ghost sm" onclick="document.getElementById('notif-avans').style.display='none'">Sonra</button>
  </div>
</div>

<!-- TOAST -->
<div id="toast" style="display:none;position:fixed;bottom:20px;left:50%;transform:translateX(-50%);padding:9px 18px;border-radius:8px;font-size:.78rem;z-index:900;color:#fff;box-shadow:0 4px 16px rgba(0,0,0,.4)"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const S = {
  period: '01-2026',
  invoices: [],
  payments: [],
  statusTab: 'hamisi',
  payFilter: 'hamisi',
  search: '',
  pendingFifo: [],
};
let _matchInvId = null, _matchPayId = null, _pendingAvansLink = null;

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SAMPLE DATA  (3V MMC â€” real values from documents)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function loadSampleData() {
  S.invoices = [
    // â”€â”€â”€ CARÄ° DÃ–VR: Yanvar 2026 â”€â”€â”€
    {id:'i01', group:'cari', dovr:'01-2026', avans:false,
     voen:'1906496911', satici:'MÄ°RE-5 MMC',
     tarix:'14-01-2026', seriya:'MT2601', no:'10711345',
     netMebleg:5000.00, edvMebleg:900.00, edvOdendi:900.00, status:'tam'},

    {id:'i02', group:'cari', dovr:'01-2026', avans:false,
     voen:'1403645031', satici:'FACÄ°LÄ°TY MANAGEMENT GROUP MMC',
     tarix:'27-01-2026', seriya:'MT2601', no:'11704067',
     netMebleg:4203.39, edvMebleg:756.61, edvOdendi:756.61, status:'tam'},

    {id:'i03', group:'cari', dovr:'01-2026', avans:false,
     voen:'1309355061', satici:'ALAZAN TEKSTÄ°L MMC',
     tarix:'29-01-2026', seriya:'MT2601', no:'11463630',
     netMebleg:3000.00, edvMebleg:540.00, edvOdendi:270.00, status:'qismen'},

    {id:'i04', group:'cari', dovr:'01-2026', avans:false,
     voen:'9900006931', satici:'LUKOIL-AZÆRBAYCAN QSC',
     tarix:'29-01-2026', seriya:'MT2601', no:'11521890',
     netMebleg:400.00, edvMebleg:72.00, edvOdendi:36.00, status:'qismen'},

    {id:'i05', group:'cari', dovr:'01-2026', avans:false,
     voen:'1402935761', satici:'DESTEC GROUP MMC',
     tarix:'20-01-2026', seriya:'MT2601', no:'11600340',
     netMebleg:430.00, edvMebleg:77.40, edvOdendi:77.40, status:'tam'},

    {id:'i06', group:'cari', dovr:'01-2026', avans:false,
     voen:'2004970411', satici:'ASSETS MMC',
     tarix:'15-01-2026', seriya:'MT2601', no:'11700210',
     netMebleg:1000.00, edvMebleg:180.00, edvOdendi:0, status:'gozleyir'},

    {id:'i07', group:'cari', dovr:'01-2026', avans:false,
     voen:'1302000471', satici:'ROYAL FOODS MMC',
     tarix:'10-01-2026', seriya:'MT2601', no:'11800550',
     netMebleg:1888.89, edvMebleg:340.00, edvOdendi:0, status:'gozleyir'},

    // â”€â”€â”€ KÃ–HNÆ DÃ–VR QALIQLAR â”€â”€â”€
    {id:'i08', group:'kohne', dovr:'11-2025', avans:false,
     voen:'1906496911', satici:'MÄ°RE-5 MMC',
     tarix:'18-11-2025', seriya:'MT2511', no:'12074787',
     netMebleg:4746.00, edvMebleg:854.24, edvOdendi:854.24, status:'tam'},

    {id:'i09', group:'kohne', dovr:'12-2025', avans:false,
     voen:'1906496911', satici:'MÄ°RE-5 MMC',
     tarix:'05-12-2025', seriya:'MT2512', no:'12316836',
     netMebleg:3000.00, edvMebleg:540.00, edvOdendi:540.00, status:'avazlesdirilib'},

    {id:'i10', group:'kohne', dovr:'11-2025', avans:false,
     voen:'1403645031', satici:'FACÄ°LÄ°TY MANAGEMENT GROUP MMC',
     tarix:'22-11-2025', seriya:'MT2511', no:'10181843',
     netMebleg:14500.00, edvMebleg:2610.00, edvOdendi:2610.00, status:'avazlesdirilib'},

    {id:'i11', group:'kohne', dovr:'06-2025', avans:false,
     voen:'1403645031', satici:'FACÄ°LÄ°TY MANAGEMENT GROUP MMC',
     tarix:'20-06-2025', seriya:'MT2506', no:'10001748',
     netMebleg:2777.78, edvMebleg:500.00, edvOdendi:500.00, status:'avazlesdirilib'},

    {id:'i12', group:'kohne', dovr:'10-2025', avans:false,
     voen:'1302000471', satici:'ROYAL FOODS MMC',
     tarix:'15-10-2025', seriya:'MT2510', no:'09876543',
     netMebleg:2350.00, edvMebleg:423.00, edvOdendi:0, status:'kohnÉ™'},

    // â”€â”€â”€ AVANS (AA seriyalÄ±) â”€â”€â”€
    {id:'i13', group:'avans', dovr:'01-2026', avans:true,
     voen:'1309355061', satici:'ALAZAN TEKSTÄ°L MMC',
     tarix:'05-01-2026', seriya:'AA2601', no:'AA2601-001',
     netMebleg:1500.00, edvMebleg:270.00, edvOdendi:270.00, status:'tam', avansLink:null},

    {id:'i14', group:'avans', dovr:'01-2026', avans:true,
     voen:'1500200311', satici:'YENÄ° TEDARÄ°KÃ‡Ä° MMC',
     tarix:'12-01-2026', seriya:'AA2601', no:'AA2601-002',
     netMebleg:1000.00, edvMebleg:180.00, edvOdendi:0, status:'gozleyir', avansLink:null},
  ];

  S.payments = [
    {id:'p1', tarix:'29-01-2026', mebleg:900.00, qaliqi:0,
     odeyiciVoen:'2302351311', qebulVoen:'1906496911', qebulAd:'MÄ°RE-5 MMC',
     tevinat:'MT2601 10711345', nov:'tam', matchedTo:'i01', status:'matched'},

    {id:'p2', tarix:'27-01-2026', mebleg:756.61, qaliqi:0,
     odeyiciVoen:'2302351311', qebulVoen:'1403645031', qebulAd:'FACÄ°LÄ°TY MANAGEMENT',
     tevinat:'MT2601 11704067', nov:'tam', matchedTo:'i02', status:'matched'},

    {id:'p3', tarix:'05-01-2026', mebleg:270.00, qaliqi:0,
     odeyiciVoen:'2302351311', qebulVoen:'1309355061', qebulAd:'ALAZAN TEKSTÄ°L',
     tevinat:'AA2601 avans', nov:'qismen', matchedTo:'i13', status:'matched'},

    {id:'p4', tarix:'29-01-2026', mebleg:36.00, qaliqi:0,
     odeyiciVoen:'2302351311', qebulVoen:'9900006931', qebulAd:'LUKOIL-AZ',
     tevinat:'MT2601 qismÉ™n', nov:'qismen', matchedTo:'i04', status:'matched'},

    {id:'p5', tarix:'20-01-2026', mebleg:77.40, qaliqi:0,
     odeyiciVoen:'2302351311', qebulVoen:'1402935761', qebulAd:'DESTEC GROUP',
     tevinat:'MT2601 11600340', nov:'tam', matchedTo:'i05', status:'matched'},

    {id:'p6', tarix:'08-01-2026', mebleg:423.00, qaliqi:423,
     odeyiciVoen:'2302351311', qebulVoen:'1302000471', qebulAd:'ROYAL FOODS',
     tevinat:'', nov:'tam', matchedTo:null, status:'unmatched'},

    {id:'p7', tarix:'03-01-2026', mebleg:350.00, qaliqi:350,
     odeyiciVoen:'2302351311', qebulVoen:'2004970411', qebulAd:'ASSETS MMC',
     tevinat:'', nov:'tam', matchedTo:null, status:'unmatched'},

    {id:'p8', tarix:'31-12-2025', mebleg:200.00, qaliqi:200,
     odeyiciVoen:'2302351311', qebulVoen:'', qebulAd:'NamÉ™lum',
     tevinat:'avans Ã¶dÉ™niÅŸ', nov:'avans', matchedTo:null, status:'avans'},
  ];

  renderAll();
  updateSummary();
  syncToLocalStorage();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER INVOICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const STATUS_MAP = {
  gozleyir:   {lbl:'AÃ§Ä±q / Ã–dÉ™nilmÉ™miÅŸ', cls:'b-gozleyir'},
  qismen:     {lbl:'QismÉ™n Ã–dÉ™nilib',    cls:'b-qismen'},
  tam:        {lbl:'Tam Ã–dÉ™nilib',       cls:'b-tam'},
  avazlesdirilib:{lbl:'ÆvÉ™zlÉ™ÅŸdirilib', cls:'b-avazlesdirilib'},
  'kohnÉ™':    {lbl:'KÃ¶hnÉ™ QalÄ±q',       cls:'b-kohne'},
  'qismÉ™n-avaz':{lbl:'Qism. ÆvÉ™zl.',   cls:'b-qismen-avaz'},
};

function renderAll() { renderInvoices(); renderPayments(); updateCounts(); }

function getFilteredInvoices() {
  let list = [...S.invoices];
  // Period filter â€” show current period + older unreconciled always
  // Status tab filter
  if (S.statusTab === 'gozleyir')  list = list.filter(i => i.edvOdendi === 0 && i.status !== 'avazlesdirilib');
  else if (S.statusTab === 'qismen') list = list.filter(i => i.status === 'qismen' || i.status === 'qismÉ™n-avaz');
  else if (S.statusTab === 'tam')  list = list.filter(i => i.status === 'tam');
  else if (S.statusTab === 'avazlesdirilib') list = list.filter(i => i.status === 'avazlesdirilib');
  else if (S.statusTab === 'kohne') list = list.filter(i => i.group === 'kohne' && i.status !== 'avazlesdirilib');
  else if (S.statusTab === 'avans') list = list.filter(i => i.avans);
  // Search
  if (S.search) list = list.filter(i =>
    [i.voen,i.satici,i.no,i.seriya,i.tarix].join(' ').toLowerCase().includes(S.search)
  );
  return list;
}

function renderInvoices() {
  const list = getFilteredInvoices();
  const tbody = document.getElementById('inv-tbody');
  const empty = document.getElementById('inv-empty');
  const tbl = document.getElementById('inv-table');

  // For "tam" tab â€” show only seriya+no focused columns
  const isTamTab = S.statusTab === 'tam';

  if (list.length === 0) {
    tbody.innerHTML = '';
    empty.style.display = 'block';
    tbl.style.display = 'none';
    return;
  }
  empty.style.display = 'none';
  tbl.style.display = 'table';

  tbody.innerHTML = list.map((inv, idx) => {
    const sm = STATUS_MAP[inv.status] || {lbl:inv.status, cls:'b-gozleyir'};
    const pct = inv.edvMebleg > 0 ? (inv.edvOdendi / inv.edvMebleg * 100).toFixed(0) : 0;
    const isOld = inv.group === 'kohne' && inv.status !== 'avazlesdirilib';
    const matchedPay = S.payments.find(p => p.matchedTo === inv.id);
    const avansTag = inv.avans ? '<span class="badge b-avans" style="margin-right:3px">AA</span>' : '';

    const qaliq = inv.edvMebleg - inv.edvOdendi;

    return `<tr class="${isOld ? 'warn-old' : ''}" onclick="openInvDetail('${inv.id}')">
      <td style="color:var(--muted);font-size:.7rem">${idx+1}</td>
      <td class="voen-cell">${inv.voen}</td>
      <td class="name-cell" title="${inv.satici}">${inv.satici}</td>
      <td style="font-size:.73rem;color:var(--muted)">${inv.tarix}</td>
      <td class="seriya-cell">${avansTag}${inv.seriya}</td>
      <td class="no-cell">${inv.no}</td>
      <td class="num edvsiz-cell">${fmt(inv.netMebleg)}</td>
      <td class="num edv-cell">${fmt(inv.edvMebleg)}</td>
      <td class="num">
        <span style="color:${inv.edvOdendi>=inv.edvMebleg?'var(--accent2)':inv.edvOdendi>0?'var(--yellow)':'var(--muted)'}">${fmt(inv.edvOdendi)}</span>
        ${inv.edvOdendi > 0 && inv.edvOdendi < inv.edvMebleg ?
          `<div><div class="prog-mini"><div class="prog-mini-fill" style="width:${pct}%"></div></div></div>` : ''}
      </td>
      <td><span class="badge ${sm.cls}">${sm.lbl}</span></td>
      <td onclick="event.stopPropagation()">
        ${inv.status === 'gozleyir' || inv.status === 'qismen' ?
          `<button class="btn ghost sm" onclick="manualMatchInv('${inv.id}')">ğŸ”—</button>` : ''}
        ${inv.status === 'tam' && inv.status !== 'avazlesdirilib' ?
          `<button class="btn success sm" onclick="markReconciled('${inv.id}')">âœ…</button>` : ''}
      </td>
    </tr>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RENDER PAYMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderPayments() {
  let list = [...S.payments];
  if (S.payFilter === 'unmatched') list = list.filter(p => p.status === 'unmatched');
  else if (S.payFilter === 'matched') list = list.filter(p => p.status === 'matched');
  else if (S.payFilter === 'avans') list = list.filter(p => p.status === 'avans');
  // Unmatched first
  list.sort((a,b) => (a.status==='unmatched'?-1:1));

  const el = document.getElementById('pay-list');
  const unmatched = S.payments.filter(p=>p.status==='unmatched');
  const ua = document.getElementById('unmatched-alert');
  document.getElementById('unmatched-cnt').textContent = unmatched.length;
  ua.style.display = unmatched.length > 0 ? 'flex' : 'none';

  if (list.length === 0) {
    el.innerHTML = '<div class="empty"><div style="font-size:1.8rem">ğŸ’³</div>Ã–dÉ™niÅŸ tapÄ±lmadÄ±</div>';
    return;
  }

  el.innerHTML = list.map(p => {
    const inv = p.matchedTo ? S.invoices.find(i=>i.id===p.matchedTo) : null;
    const novClr = {tam:'var(--accent2)',qismen:'var(--yellow)',avans:'var(--cyan)'}[p.nov]||'var(--muted)';
    const matchInfo = inv
      ? `<div class="pay-match-lbl" onclick="openInvDetail('${inv.id}')">â†’ ${inv.seriya} ${inv.no} â€” ${inv.satici.substring(0,22)}</div>`
      : `<div style="color:var(--yellow);font-size:.68rem;margin-top:3px">âš ï¸ EÅŸlÉ™ÅŸdirilmÉ™miÅŸ â€” <span class="match-link" onclick="manualMatchPay('${p.id}')">BaÄŸla</span></div>`;

    return `<div class="pay-row ${p.status}" onclick="${p.status==='unmatched'?`manualMatchPay('${p.id}')`:'void(0)'}">
      <div class="pay-head">
        <div>
          <span style="font-size:.72rem;color:var(--muted)">${p.tarix}</span>
          <span class="badge" style="background:rgba(30,42,58,.8);color:${novClr};margin-left:6px">${p.nov}</span>
        </div>
        <div class="pay-amount">${fmt(p.mebleg)} â‚¼</div>
      </div>
      <div class="pay-sub">${p.qebulAd || 'â€”'} ${p.qebulVoen?`<span style="color:var(--muted)">(${p.qebulVoen})</span>`:''}</div>
      <div class="pay-ref">${p.tevinat || '<span style="color:var(--muted);font-style:italic">TÉ™yinat gÃ¶stÉ™rilmÉ™yib</span>'}</div>
      ${p.qaliqi > 0 ? `<div style="font-size:.68rem;color:var(--yellow);margin-top:2px">QalÄ±q: ${fmt(p.qaliqi)} â‚¼</div>` : ''}
      ${matchInfo}
    </div>`;
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  COUNTS + SUMMARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateCounts() {
  const invs = S.invoices;
  document.getElementById('cnt-hamisi').textContent = invs.length;
  document.getElementById('cnt-gozleyir').textContent = invs.filter(i=>i.edvOdendi===0&&i.status!=='avazlesdirilib').length;
  document.getElementById('cnt-qismen').textContent = invs.filter(i=>i.status==='qismen'||i.status==='qismÉ™n-avaz').length;
  document.getElementById('cnt-tam').textContent = invs.filter(i=>i.status==='tam').length;
  document.getElementById('cnt-avaz').textContent = invs.filter(i=>i.status==='avazlesdirilib').length;
  document.getElementById('cnt-kohne').textContent = invs.filter(i=>i.group==='kohne'&&i.status!=='avazlesdirilib').length;
  document.getElementById('cnt-avans').textContent = invs.filter(i=>i.avans).length;

  const ms = document.getElementById('match-stat');
  const tot = S.payments.length;
  const matched = S.payments.filter(p=>p.status==='matched').length;
  ms.textContent = `${matched}/${tot} Ã¶dÉ™niÅŸ eÅŸlÉ™ÅŸdirildi`;
}

function updateSummary() {
  const ready = S.invoices.filter(i=>i.status==='tam');
  const cari  = ready.filter(i=>i.group==='cari').reduce((s,i)=>s+i.edvMebleg,0);
  const kohne = ready.filter(i=>i.group==='kohne').reduce((s,i)=>s+i.edvMebleg,0);
  const avans = ready.filter(i=>i.avans).reduce((s,i)=>s+i.edvMebleg,0);
  const total = cari+kohne+avans;
  const goz   = S.invoices.filter(i=>i.edvOdendi===0&&i.status!=='avazlesdirilib').reduce((s,i)=>s+i.edvMebleg,0);
  const qis   = S.invoices.filter(i=>i.status==='qismen').reduce((s,i)=>s+(i.edvMebleg-i.edvOdendi),0);
  const san   = S.payments.filter(p=>p.status==='avans').reduce((s,p)=>s+p.mebleg,0);
  const allEdv= S.invoices.reduce((s,i)=>s+i.edvMebleg,0);
  const pct   = allEdv>0?Math.round(total/allEdv*100):0;

  set('sv-cari',  fmt(cari)+' â‚¼');
  set('sv-kohne', fmt(kohne)+' â‚¼');
  set('sv-avans', fmt(avans)+' â‚¼');
  set('sv-total', fmt(total)+' â‚¼');
  set('sv-goz',   fmt(goz)+' â‚¼');
  set('sv-qis',   fmt(qis)+' â‚¼');
  set('sv-san',   fmt(san)+' â‚¼');
  set('sv-pct',   pct+'%');

  // Warnings
  const warns=[];
  const oldOpen = S.invoices.filter(i=>i.group==='kohne'&&i.status!=='avazlesdirilib'&&i.edvMebleg>0);
  if(oldOpen.length>0) warns.push(`<div class="alert-strip warn">â° ${oldOpen.length} kÃ¶hnÉ™ qaimÉ™ É™vÉ™zlÉ™ÅŸdirilmÉ™yib â€” ${fmt(oldOpen.reduce((s,i)=>s+i.edvMebleg,0))} â‚¼</div>`);
  if(san>0) warns.push(`<div class="alert-strip err">ğŸš¨ ${fmt(san)} â‚¼ sÉ™nÉ™dsiz avans depozit â€” sÉ™nÉ™d olmadan É™vÉ™zlÉ™ÅŸdirmÉ™ mÃ¼mkÃ¼n deyil</div>`);
  if(goz>0) warns.push(`<div class="alert-strip info">ğŸ’¡ ${fmt(goz)} â‚¼ ÆDV depozit Ã¶dÉ™niÅŸi gÃ¶zlÉ™nilir (${S.invoices.filter(i=>i.edvOdendi===0&&i.status!=='avazlesdirilib').length} qaimÉ™ aÃ§Ä±qdÄ±r)</div>`);
  document.getElementById('sum-warnings').innerHTML = warns.join('');

  // Alert strip in invoice panel
  const invAlerts = document.getElementById('inv-alerts');
  invAlerts.innerHTML = warns.join('');

  syncToLocalStorage();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SYNC â†’ localStorage (index.html oxuyacaq)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function syncToLocalStorage() {
  const ready = S.invoices.filter(i=>i.status==='tam'||i.status==='avazlesdirilib');
  const total = ready.reduce((s,i)=>s+i.edvMebleg,0);
  const data = {
    period: S.period,
    updatedAt: new Date().toISOString(),
    invoices: S.invoices,
    payments: S.payments,
    summary: {
      cari:  S.invoices.filter(i=>i.status==='tam'&&i.group==='cari').reduce((s,i)=>s+i.edvMebleg,0),
      kohne: S.invoices.filter(i=>i.status==='tam'&&i.group==='kohne').reduce((s,i)=>s+i.edvMebleg,0),
      avans: S.invoices.filter(i=>i.status==='tam'&&i.avans).reduce((s,i)=>s+i.edvMebleg,0),
      total,
      kat1Rows: ready.map(i=>({seriya:i.seriya,no:i.no,edv:i.edvMebleg,satici:i.satici,voen:i.voen,tarix:i.tarix}))
    }
  };
  try {
    localStorage.setItem('edv_avazlesme', JSON.stringify(data));
    const ind = document.getElementById('sync-indicator');
    ind.textContent = 'âœ… Sinxronizasiya olundu';
    ind.className = 'sync-badge';
  } catch(e) { /* localStorage yoxdur */ }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MATCHING ENGINE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function runAutoMatch() {
  const proposals = [];
  const unmatched = S.payments.filter(p=>p.status==='unmatched');
  if(unmatched.length===0){toast('âœ… EÅŸlÉ™ÅŸdirilmÉ™miÅŸ Ã¶dÉ™niÅŸ yoxdur');return;}

  unmatched.forEach(pay => {
    let remaining = pay.mebleg;

    // LVL 1 â€” BirbaÅŸa (tÉ™yinata gÃ¶rÉ™)
    if (pay.tevinat && pay.tevinat.trim()) {
      const ref = pay.tevinat.replace(/\s+/g,'').toUpperCase();
      const inv = S.invoices.find(i=>{
        const k = (i.seriya+i.no).replace(/\s+/g,'').toUpperCase();
        return ref.includes(k) || k.includes(ref.substring(0,6));
      });
      if (inv && inv.status!=='avazlesdirilib') {
        const amt = Math.min(remaining, inv.edvMebleg-inv.edvOdendi);
        if(amt>0) {proposals.push({payId:pay.id,invId:inv.id,amount:amt,level:1,reason:'BirbaÅŸa (tÉ™yinat Ã¼zrÉ™)'});return;}
      }
    }

    // LVL 2 â€” FIFO
    const pool = S.invoices
      .filter(i=>i.status!=='avazlesdirilib'&&i.edvMebleg>i.edvOdendi)
      .sort((a,b)=>a.tarix.split('-').reverse().join('').localeCompare(b.tarix.split('-').reverse().join('')));

    pool.forEach(inv => {
      if(remaining<=0.001)return;
      const needed = inv.edvMebleg-inv.edvOdendi;
      const alloc = Math.min(remaining, needed);
      if(alloc>0){proposals.push({payId:pay.id,invId:inv.id,amount:alloc,level:2,reason:'FIFO (É™n kÃ¶hnÉ™ qaimÉ™)'});remaining-=alloc;}
    });

    // LVL 3 â€” Avans
    if(remaining>0.001){
      proposals.push({payId:pay.id,invId:null,amount:remaining,level:3,reason:'Avans depozit (qaimÉ™ yoxdur)'});
    }
  });

  if(proposals.length===0){toast('EÅŸlÉ™ÅŸdirmÉ™ Ã¼Ã§Ã¼n aÃ§Ä±q qaimÉ™ tapÄ±lmadÄ±');return;}
  S.pendingFifo=proposals;
  showFifoModal(proposals);
}

function showFifoModal(proposals) {
  const lvlBadge=l=>l===1?'<span class="badge b-tam">BirbaÅŸa</span>':l===2?'<span class="badge b-qismen">FIFO</span>':'<span class="badge b-avans">Avans</span>';
  document.getElementById('fifo-proposals').innerHTML = proposals.map((p,i)=>{
    const pay = S.payments.find(x=>x.id===p.payId);
    const inv = p.invId ? S.invoices.find(x=>x.id===p.invId) : null;
    return `<div class="fifo-row">
      ${lvlBadge(p.level)}
      <div style="flex:1">
        <div style="font-size:.76rem;font-weight:600">
          ğŸ’³ ${fmt(pay.mebleg)} â‚¼ (${pay.tarix}) â†’
          ${inv ? `ğŸ“‹ ${inv.seriya} ${inv.no} â€” ${inv.satici.substring(0,20)} â€” <strong>${fmt(p.amount)} â‚¼</strong>` : 'ğŸ“Œ Avans kimi qeyd et'}
        </div>
        <div style="font-size:.67rem;color:var(--muted);margin-top:2px">${p.reason}</div>
      </div>
      <button class="btn danger sm" onclick="S.pendingFifo.splice(${i},1);showFifoModal(S.pendingFifo)">âœ•</button>
    </div>`;
  }).join('');
  document.getElementById('modal-fifo').classList.add('show');
}

function confirmFifo() {
  S.pendingFifo.forEach(p=>{
    const pay = S.payments.find(x=>x.id===p.payId);
    const inv = p.invId ? S.invoices.find(x=>x.id===p.invId) : null;
    if(!pay)return;
    if(!inv||p.level===3){pay.status='avans';return;}
    inv.edvOdendi = Math.min(inv.edvMebleg, inv.edvOdendi+p.amount);
    inv.status = inv.edvOdendi>=inv.edvMebleg ? 'tam' : 'qismen';
    pay.matchedTo = inv.id;
    pay.qaliqi = Math.max(0, pay.mebleg-p.amount);
    pay.status = pay.qaliqi>0.01 ? 'unmatched' : 'matched';
  });
  S.pendingFifo=[];
  closeModal('modal-fifo');
  renderAll();updateSummary();
  toast('âœ… EÅŸlÉ™ÅŸdirmÉ™ tamamlandÄ±');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MANUAL MATCH
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function manualMatchInv(invId) {
  _matchInvId=invId; _matchPayId=null;
  const inv=S.invoices.find(i=>i.id===invId);
  const unmatched=S.payments.filter(p=>p.status==='unmatched');
  document.getElementById('modal-match-body').innerHTML=`
    <p style="font-size:.76rem;color:var(--muted);margin-bottom:10px">QaimÉ™: <strong>${inv.seriya} ${inv.no}</strong> â€” ${inv.satici} â€” ÆDV: ${fmt(inv.edvMebleg)} â‚¼</p>
    <select id="sel-pay-match" style="width:100%;background:var(--card2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:.78rem">
      ${unmatched.map(p=>`<option value="${p.id}">${p.tarix} â€” ${fmt(p.mebleg)} â‚¼ â€” ${p.qebulAd||'?'} (${p.tevinat||'TÉ™yinatsÄ±z'})</option>`).join('')}
    </select>
    <div style="margin-top:10px"><label style="font-size:.7rem;color:var(--muted)">BaÄŸlanan mÉ™blÉ™ÄŸ (â‚¼)</label>
    <input type="number" id="match-amount" value="${(inv.edvMebleg-inv.edvOdendi).toFixed(2)}" step="0.01"
      style="width:100%;background:var(--card2);border:1px solid var(--border);color:var(--text);padding:7px;border-radius:6px;margin-top:4px;font-size:.8rem"></div>`;
  document.getElementById('modal-match').classList.add('show');
}

function manualMatchPay(payId) {
  _matchPayId=payId; _matchInvId=null;
  const pay=S.payments.find(p=>p.id===payId);
  const openInvs=S.invoices.filter(i=>i.status!=='avazlesdirilib'&&i.edvMebleg>i.edvOdendi);
  document.getElementById('modal-match-body').innerHTML=`
    <p style="font-size:.76rem;color:var(--muted);margin-bottom:10px">Ã–dÉ™niÅŸ: <strong>${fmt(pay.mebleg)} â‚¼</strong> â€” ${pay.tarix} â€” ${pay.qebulAd||'?'}</p>
    <p style="font-size:.72rem;color:var(--yellow);margin-bottom:10px">TÉ™yinat: "${pay.tevinat||'(Yoxdur)'}"</p>
    <select id="sel-inv-match" style="width:100%;background:var(--card2);border:1px solid var(--border);color:var(--text);padding:8px;border-radius:6px;font-size:.78rem">
      ${openInvs.map(i=>`<option value="${i.id}">${i.seriya} ${i.no} â€” ${i.satici.substring(0,25)} â€” ÆDV: ${fmt(i.edvMebleg)} â‚¼ (${i.status})</option>`).join('')}
    </select>`;
  document.getElementById('modal-match').classList.add('show');
}

function confirmManualMatch() {
  if(_matchInvId) {
    const selId=document.getElementById('sel-pay-match')?.value;
    const amt=parseFloat(document.getElementById('match-amount')?.value)||0;
    if(!selId)return closeModal('modal-match');
    const pay=S.payments.find(p=>p.id===selId);
    const inv=S.invoices.find(i=>i.id===_matchInvId);
    inv.edvOdendi=Math.min(inv.edvMebleg,inv.edvOdendi+amt);
    inv.status=inv.edvOdendi>=inv.edvMebleg?'tam':'qismen';
    pay.matchedTo=inv.id;pay.status='matched';pay.qaliqi=Math.max(0,pay.mebleg-amt);
  } else if(_matchPayId) {
    const selId=document.getElementById('sel-inv-match')?.value;
    if(!selId)return closeModal('modal-match');
    const pay=S.payments.find(p=>p.id===_matchPayId);
    const inv=S.invoices.find(i=>i.id===selId);
    inv.edvOdendi=Math.min(inv.edvMebleg,inv.edvOdendi+pay.mebleg);
    inv.status=inv.edvOdendi>=inv.edvMebleg?'tam':'qismen';
    pay.matchedTo=inv.id;pay.status='matched';pay.qaliqi=0;
  }
  _matchInvId=null;_matchPayId=null;
  closeModal('modal-match');renderAll();updateSummary();
  toast('âœ… Æl ilÉ™ eÅŸlÉ™ÅŸdirmÉ™ tamamlandÄ±');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INVOICE DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openInvDetail(id) {
  const inv=S.invoices.find(i=>i.id===id);
  const linkedPay=S.payments.filter(p=>p.matchedTo===id);
  const sm=STATUS_MAP[inv.status]||{lbl:inv.status,cls:'b-gozleyir'};
  document.getElementById('modal-inv-title').textContent=`${inv.seriya} ${inv.no}`;
  document.getElementById('modal-inv-body').innerHTML=`
    <table class="modal-tbl">
      <tr><th>VÃ–EN</th><td>${inv.voen}</td><th>SatÄ±cÄ±</th><td>${inv.satici}</td></tr>
      <tr><th>Tarix</th><td>${inv.tarix}</td><th>DÃ¶vr</th><td>${inv.dovr}</td></tr>
      <tr><th>Seriya</th><td class="seriya-cell">${inv.seriya}</td><th>QaimÉ™ â„–</th><td>${inv.no}</td></tr>
      <tr><th>ÆDV-siz dÉ™yÉ™r</th><td>${fmt(inv.netMebleg)} â‚¼</td><th>ÆDV mÉ™blÉ™ÄŸi</th><td class="edv-cell">${fmt(inv.edvMebleg)} â‚¼</td></tr>
      <tr><th>Ã–dÉ™nilmiÅŸ ÆDV</th><td>${fmt(inv.edvOdendi)} â‚¼</td><th>QalÄ±q</th><td style="color:${inv.edvMebleg>inv.edvOdendi?'var(--yellow)':'var(--accent2)'}">${fmt(inv.edvMebleg-inv.edvOdendi)} â‚¼</td></tr>
      <tr><th>Status</th><td colspan="3"><span class="badge ${sm.cls}">${sm.lbl}</span> ${inv.avans?'<span class="badge b-avans">Avans AA</span>':''}</td></tr>
    </table>
    ${linkedPay.length>0?`
    <div style="margin-top:12px;font-size:.76rem;font-weight:700;margin-bottom:6px">BaÄŸlÄ± depozit Ã¶dÉ™niÅŸlÉ™ri:</div>
    ${linkedPay.map(p=>`<div style="background:var(--card2);border-radius:6px;padding:7px 10px;font-size:.74rem;margin-bottom:5px;display:flex;justify-content:space-between">
      <span>ğŸ’³ ${p.tarix} â€” <span style="color:var(--muted)">${p.tevinat||'TÉ™yinatsÄ±z'}</span></span>
      <span style="color:var(--accent2);font-weight:700">${fmt(p.mebleg)} â‚¼</span>
    </div>`).join('')}`:''}
    <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
      ${inv.status==='tam'?`<button class="btn success sm" onclick="markReconciled('${inv.id}');closeModal('modal-inv')">âœ… ÆvÉ™zlÉ™ÅŸdirilib qeyd et</button>`:''}
      ${inv.status==='gozleyir'||inv.status==='qismen'?`<button class="btn primary sm" onclick="closeModal('modal-inv');manualMatchInv('${inv.id}')">ğŸ”— Depozit baÄŸla</button>`:''}
    </div>`;
  document.getElementById('modal-inv').classList.add('show');
}

function markReconciled(id) {
  const inv=S.invoices.find(i=>i.id===id);
  if(inv.edvOdendi>=inv.edvMebleg)inv.status='avazlesdirilib';
  else inv.status='qismÉ™n-avaz';
  renderAll();updateSummary();toast('âœ… ÆvÉ™zlÉ™ÅŸdirilib statusu verildi');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FINAL REPORT MODAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openFinalModal() {
  const period=document.getElementById('sel-ay').options[document.getElementById('sel-ay').selectedIndex].text;
  document.getElementById('final-period').textContent=period;
  const ready=S.invoices.filter(i=>i.status==='tam'||i.status==='avazlesdirilib');
  const total=ready.reduce((s,i)=>s+i.edvMebleg,0);
  document.getElementById('modal-final-body').innerHTML=`
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-bottom:14px">
      <div class="sum-item"><div class="sum-lbl">Cari dÃ¶vr</div><div class="sum-val sv-green">${fmt(ready.filter(i=>i.group==='cari').reduce((s,i)=>s+i.edvMebleg,0))} â‚¼</div></div>
      <div class="sum-item"><div class="sum-lbl">KÃ¶hnÉ™ dÃ¶vr</div><div class="sum-val sv-cyan">${fmt(ready.filter(i=>i.group==='kohne').reduce((s,i)=>s+i.edvMebleg,0))} â‚¼</div></div>
      <div class="sum-item"><div class="sum-lbl">Avans (AA)</div><div class="sum-val sv-purple">${fmt(ready.filter(i=>i.avans).reduce((s,i)=>s+i.edvMebleg,0))} â‚¼</div></div>
      <div class="sum-item" style="border:1px solid var(--accent2)"><div class="sum-lbl">CÆMÄ° (GÃ¶stÉ™rici 1016)</div><div class="sum-val sv-green">${fmt(total)} â‚¼</div></div>
    </div>
    <table class="modal-tbl">
      <thead><tr><th>#</th><th>SÉ™tir</th><th>Seriya</th><th>QaimÉ™ â„–</th><th>SatÄ±cÄ±</th><th style="text-align:right">ÆDV (â‚¼)</th></tr></thead>
      <tbody>${ready.map((inv,i)=>`<tr>
        <td>${i+1}</td><td>308</td>
        <td class="seriya-cell">${inv.seriya}</td>
        <td>${inv.no}</td>
        <td style="font-size:.72rem">${inv.satici.substring(0,28)}</td>
        <td style="text-align:right;font-weight:700;color:var(--accent2)">${fmt(inv.edvMebleg)}</td>
      </tr>`).join('')}
      <tr style="font-weight:800;background:rgba(99,102,241,.08)">
        <td colspan="5" style="font-weight:800">CÆMÄ°</td>
        <td style="text-align:right;color:var(--accent2);font-weight:800">${fmt(total)}</td>
      </tr></tbody>
    </table>`;
  document.getElementById('modal-final').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  IMPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function importQaimeler(input) {
  const f=input.files[0]; if(!f)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const data=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      let added=0;
      data.forEach((row,i)=>{
        if(i<1)return;
        const no=String(row[3]||'').trim();
        const seriya=String(row[4]||'').trim();
        if(!no||!seriya||no==='0')return;
        const edv=parseFloat(String(row[9]||row[8]||'0').replace(',','.'));
        const net=parseFloat(String(row[7]||row[6]||'0').replace(',','.'));
        if(isNaN(edv)||edv<=0)return;
        const tarix=String(row[1]||'');
        const isAvans=seriya.startsWith('AA');
        const invPeriod=tarix.substring(6,10)+'-'+tarix.substring(3,5); // YYYY-MM
        const isOld=invPeriod<S.period&&S.period;
        S.invoices.push({
          id:'q'+Date.now()+'_'+i, group:isAvans?'avans':isOld?'kohne':'cari',
          dovr:tarix.substring(3,10), avans:isAvans, avansLink:null,
          voen:String(row[6]||''), satici:String(row[5]||'NamÉ™lum').trim(),
          tarix, seriya, no,
          netMebleg:isNaN(net)?edv/0.18:net,
          edvMebleg:edv, edvOdendi:0, status:'gozleyir',
        });
        added++;
      });
      renderAll();updateSummary();
      toast('âœ… '+added+' qaimÉ™ idxal edildi');
    }catch(err){toast('âŒ '+err.message,'err');}
  };
  reader.readAsArrayBuffer(f);
}

function importDepozit(input) {
  const f=input.files[0]; if(!f)return;
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const wb=XLSX.read(e.target.result,{type:'array'});
      const ws=wb.Sheets[wb.SheetNames[0]];
      const data=XLSX.utils.sheet_to_json(ws,{header:1,defval:''});
      let added=0;
      data.forEach((row,i)=>{
        if(i<1)return;
        const mebleg=parseFloat(String(row[1]||row[5]||'0').replace(',','.'));
        if(isNaN(mebleg)||mebleg<=0)return;
        const sts=String(row[7]||'').toLowerCase();
        if(sts.includes('lÉ™ÄŸv')||sts.includes('cancel'))return;
        S.payments.push({
          id:'dep'+Date.now()+'_'+i,
          tarix:String(row[0]||''), mebleg, qaliqi:mebleg,
          odeyiciVoen:String(row[2]||'2302351311'),
          qebulVoen:String(row[3]||''), qebulAd:String(row[3]||''),
          tevinat:String(row[4]||''),
          nov:sts.includes('qism')?'qismen':'tam',
          matchedTo:null, status:'unmatched'
        });
        added++;
      });
      renderAll();updateSummary();
      toast('âœ… '+added+' depozit Ã¶dÉ™niÅŸi idxal edildi');
      setTimeout(()=>runAutoMatch(),600);
    }catch(err){toast('âŒ '+err.message,'err');}
  };
  reader.readAsArrayBuffer(f);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EXPORT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function exportAvaz() {
  const ready=S.invoices.filter(i=>i.status==='tam'||i.status==='avazlesdirilib');
  if(typeof XLSX==='undefined'||ready.length===0){toast('âŒ Ixrac Ã¼Ã§Ã¼n data yoxdur','err');return;}
  const rows=ready.map(i=>[308,i.seriya,i.no,i.edvMebleg]);
  const wb=XLSX.utils.book_new();
  const ws=XLSX.utils.aoa_to_sheet(rows);
  XLSX.utils.book_append_sheet(wb,ws,'Avazlesdirme');
  XLSX.writeFile(wb,'avazlesdirme_'+S.period.replace('-','_')+'.xlsx');
  closeModal('modal-final');
  toast('âœ… Fayl yÃ¼klÉ™ndi');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AVANS NOTIF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkAvansMatch() {
  const avDep=S.payments.filter(p=>p.status==='avans');
  const openInv=S.invoices.filter(i=>!i.avans&&i.status==='gozleyir');
  if(avDep.length&&openInv.length){
    const d=avDep[0],inv=openInv[0];
    _pendingAvansLink={depId:d.id,invId:inv.id};
    document.getElementById('notif-avans-text').textContent=`${fmt(d.mebleg)} â‚¼ avans depozit â€” "${inv.satici}" (${inv.seriya} ${inv.no}) qaimÉ™sinÉ™ uyÄŸun gÃ¶rÃ¼nÃ¼r`;
    document.getElementById('notif-avans').style.display='block';
  }
}
function acceptAvansLink() {
  if(!_pendingAvansLink)return;
  const dep=S.payments.find(p=>p.id===_pendingAvansLink.depId);
  const inv=S.invoices.find(i=>i.id===_pendingAvansLink.invId);
  if(dep&&inv){dep.matchedTo=inv.id;dep.status='matched';inv.edvOdendi+=dep.mebleg;inv.status=inv.edvOdendi>=inv.edvMebleg?'tam':'qismen';}
  document.getElementById('notif-avans').style.display='none';
  _pendingAvansLink=null;renderAll();updateSummary();toast('âœ… Avans Ã¶dÉ™niÅŸ baÄŸlandÄ±');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UI HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStatusTab(btn,tab) {
  document.querySelectorAll('.itab').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
  S.statusTab=tab;
  renderInvoices();
}
function setPayFilter(chip,val) {
  document.querySelectorAll('#pay-chips .chip').forEach(c=>c.classList.remove('active'));
  chip.classList.add('active');
  S.payFilter=val;renderPayments();
}
function filterInvoices(v){S.search=v.toLowerCase();renderInvoices();}
function changePeriod(){
  S.period=document.getElementById('sel-ay').value;
  const lbl=document.getElementById('sel-ay').options[document.getElementById('sel-ay').selectedIndex].text;
  document.getElementById('sum-period-lbl').textContent=lbl;
  renderAll();updateSummary();
}
function toggleSum(){const b=document.getElementById('sum-body');const h=b.style.display==='none';b.style.display=h?'':'none';document.getElementById('sum-toggle').textContent=h?'â–²':'â–¼';}
function closeModal(id){document.getElementById(id).classList.remove('show');}
function addInvManual(){toast('Excel import istifadÉ™ edin (e-taxes.gov.az â†’ Daxil olan qaimÉ™lÉ™r)');}
function addPayManual(){toast('Excel import istifadÉ™ edin (e-taxes.gov.az â†’ ÆDV depozit hesabÄ±)');}
function fmt(n){return Number(n||0).toLocaleString('az',{minimumFractionDigits:2,maximumFractionDigits:2});}
function set(id,v){const el=document.getElementById(id);if(el)el.textContent=v;}
function toast(msg,type='ok'){
  const t=document.getElementById('toast');
  t.textContent=msg;t.style.background=type==='err'?'var(--red)':'var(--accent2)';
  t.style.display='block';setTimeout(()=>t.style.display='none',3200);
}

// â”€â”€ Ä°NÄ°T â”€â”€
loadSampleData();
</script>
</body>
</html>
